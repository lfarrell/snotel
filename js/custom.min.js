d3.queue().defer(d3.csv,"web_files/grouped_0.csv").defer(d3.csv,"web_files/grouped_2.csv").defer(d3.csv,"web_files/grouped_3.csv").defer(d3.json,"js/western_us.geojson").await(function(x,k,C,t,D){function E(a,f,b){var e=5<b||500>n?0:10,g=5<b?y:[1,3],c=5<b?z.reverse():z,F=d3.scaleQuantile().domain(d3.extent(a,d3.f("temp_mean"))).range(c),h=d3.scaleSqrt().domain(d3.extent(a,d3.f("snow_mean"))).range(g);G(f+"-legend-temp",F);H(f+"-legend",h);var A=I(a,"date",u),g=_.pluck(_.uniq(a,function(a){return a.elev}),
    "elev"),k=J(g,v),g=d3.axisBottom().scale(A).tickFormat(d3.timeFormat(K)),c=d3.axisLeft().scale(k).tickFormat(d3.format(",d")),B=l(f).append("svg").attr("id","graph-"+b).attr("width",u+d.left+d.right).attr("height",v+d.top+d.bottom);(function(a,b,c){c=c?0:v;a.append("g").attr("class","axis x").translate([d.left,c+d.top]);d3.select(f+" g.x").call(b)})(B,g,!0);(function(a,b){a.append("g").attr("class","axis y").translate([d.left-25,d.top]);d3.select(f+" g.y").call(b)})(B,c);a=B.selectAll("circle").data(a);
    a.enter().append("circle").merge(a).translate([d.left-e,d.top]).style("fill",function(a){return F(a.temp_mean)}).attr("cx",function(a){return A(a.date)}).attr("cy",function(a){return k(a.elev)}).attr("r",function(a){return h(a.snow_mean)}).on("mouseover touchstart",function(a){p.transition().duration(100).style("opacity",.9);var c=5<b?"":" ("+M(a.date.getUTCMonth())+")";p.html('<h4 class="text-center">'+a.date.getFullYear()+c+'</h4><h5  class="text-center">Snow/Water Equivalence</h5><ul class="list-unstyled"<li>Elevation: '+
        a.elev+"+ feet</li><li>Temp Mean: "+a.temp_mean+" degrees</li><li>Water Mean: "+a.snow_mean+" inches</li><li>Water Median: "+a.snow_median+" inches</li></ul>").style("top",d3.event.pageY+18+"px").style("left",d3.event.pageX-55+"px");d3.select(this).attr("r",1.3*h(a.snow_mean))}).on("mouseout touchend",function(a){p.transition().duration(250).style("opacity",0);d3.select(this).attr("r",h(a.snow_mean))});a.exit().remove();20===b&&500<=n&&(e=[{xVal:m("2008"),yVal:3E3,path:"M112,93L89,38",text:"Max Water Levels",
        textOffset:[73,109]},{xVal:m("2005"),yVal:2E3,path:"M96,67L76,27",text:"Min Water Levels",textOffset:[63,83]},{xVal:m("2002"),yVal:1E4,path:"M35,-13L69,19",text:"Min Temp Levels",textOffset:[-7,-18]},{xVal:m("2016"),yVal:3E3,path:"M36,93L66,33",text:"Max Temp Levels",textOffset:[-3,112]}],q("#graph-"+b,e,A,k))}function I(a,f,b){b=d3.scaleTime().range([0,b]);b.domain(d3.extent(a,d3.f(f)));return b}function J(a,f){var b=d3.scaleBand().rangeRound([f,0]).padding(1);b.domain(a);return b}function q(a,f,b,e){var g=d3.swoopyDrag().x(function(a){return b(a.xVal)}).y(function(a){return e(a.yVal)}).draggable(0);g.annotations(f);l(a).append("g.annotations").call(g)}function H(a,f){var b=window.innerWidth,e,g;1E3>b?(e="vertical",g=10):(e="horizontal",g=25);var c=/el/.test(a)?30:15,d="vertical"===e?230:75,b=1E3>b?200:900,d=l(a).classed("svg",!0).attr("width",b).attr("height",d);d.append("g").attr("class","legendSize").translate([30,g]);e=d3.legendSize().scale(f).shape("circle").shapePadding(c).labelOffset(20).orient(e);d.select(".legendSize").call(e);return d}function G(a,d){var b=window.innerWidth,e,g;1E3>b?(e=40,g="vertical"):(e=70,g="horizontal");var c="vertical"===g?230:75,f=1E3>b?200:900,b=a.substr(1),c=l(a).classed("svg",!0).classed("legend",!0).attr("width",f).attr("height",c);c.append("g").attr("class","legend-"+b).attr("width",f).translate([0,20]);e=d3.legendColor().shapeWidth(e).orient(g).labelFormat(d3.format(".01f")).scale(d);c.select(".legend-"+b).call(e);return c}function N(a,d,b,e){var g=l(a).append("svg").attr("vector-effect",
    "non-scaling-stroke").append("g"),c=1,c=d3.geoAlbersUsa().scale(c).translate([0,0]),f=d3.geoPath().projection(c),h=f.bounds(D),c=.95/Math.max((h[1][0]-h[0][0])/b,(h[1][1]-h[0][1])/d),h=[(b-c*(h[1][0]+h[0][0]))/2-35,(d-c*(h[1][1]+h[0][1]))/2],c=d3.geoAlbersUsa().scale(c).translate(h),f=f.projection(c);l(a+" svg").attr("height",d).attr("width",b).attr("class","map");a=g.selectAll("path").data(D.features);a.enter().append("path").merge(a).attr("d",f).style("stroke",function(a){if(r[e]===a.properties.name)return"orange"}).style("opacity",
    function(a){if(r[e]===a.properties.name)return.8}).style("fill",function(a){if(r[e]===a.properties.name)return"orange"});a.exit().remove()}function M(a){switch(a){case 0:return"January";case 1:return"February";case 2:return"March";case 3:return"April";case 4:return"May";case 5:return"June";case 6:return"July";case 7:return"August";case 8:return"September";case 9:return"October";case 10:return"November";case 11:return"December";default:return"unknown"}}var d={top:25,right:40,bottom:50,left:75},z="#a50026 #d73027 #f46d43 #fdae61 #fee090 #ffffbf #e0f3f8 #abd9e9 #74add1 #4575b4 #313695".split(" "),
    O=d3.timeParse("%m/%Y"),m=d3.timeParse("%Y"),v=500-d.top-d.bottom,n=window.innerWidth,K=500>=n?"%y":"%Y",u=n-100-d.right-d.left,l=d3.select;x=d3.selectAll;var p=l("body").append("div").attr("class","tooltip").style("opacity",0),r={AZ:"Arizona",CA:"California",CO:"Colorado",ID:"Idaho",MT:"Montana",NV:"Nevada",NM:"New Mexico",OR:"Oregon",UT:"Utah",WA:"Washington",WY:"Wyoming"},y;y=500>n?[1,6]:[2,20];k.forEach(function(a){a.date=m(a.year);a.snow_mean=+a.snow_mean;a.temp_mean=+a.temp_mean;a.elev+="000"});
    C.forEach(function(a){a.date=O(a.month+"/"+a.year);a.snow_mean=+a.snow_mean;a.temp_mean=+a.temp_mean});t.forEach(function(a){a.date=m(a.year);a.snow_mean=+a.snow_mean;a.temp_mean=+a.temp_mean;a.elev+="000"});E(k,"#year-month",20);E(C,"#el-year-month",5);k=_.keys(r);var L=d3.scaleQuantile().domain(d3.extent(t,d3.f("temp_mean"))).range(z),w=d3.scaleSqrt().domain(d3.extent(t,d3.f("snow_mean"))).range(y);G("#states-legend-temp",L);H("#states-legend",w);k.forEach(function(a,f){var b=t.filter(function(b){return b.state===
        a});l("#states").append("div").attr("class","graph").attr("id","graphed"+f);N("#graphed"+f,100,window.innerWidth,a);l("#graphed"+f).append("h2").attr("class","text-center text-top").text(r[a]);var e=_.pluck(_.uniq(b,"elev"),"elev"),g=I(b,"date",u),c=J(e,45*e.length),k=d3.axisTop().scale(g).tickFormat(d3.timeFormat(K)),h=d3.axisLeft().scale(c).tickFormat(d3.format(",d")),e=l("#graphed"+f).append("svg").attr("id",a).attr("width",u+d.left+d.right).attr("height",50*e.length);(function(a,b,c){c=c?0:v;
        a.append("g").attr("class","axis x").translate([d.left,c+d.top]);d3.select("#graphed"+f+" g.x").call(b)})(e,k,!0);(function(a,b){a.append("g").attr("class","axis y").translate([d.left-25,d.top]);d3.select("#graphed"+f+" g.y").call(b)})(e,h);b=e.selectAll("circle").data(b);b.enter().append("circle").merge(b).translate([d.left,d.top]).style("fill",function(a){return L(a.temp_mean)}).attr("cx",function(a){return g(a.date)}).attr("cy",function(a){return c(a.elev)}).attr("r",function(a){return w(a.snow_mean)}).on("mouseover touchstart",
        function(a){p.transition().duration(100).style("opacity",.9);p.html('<h4 class="text-center">'+a.date.getFullYear()+'</h4><h5  class="text-center">Snow/Water Equivalence</h5><ul class="list-unstyled"<li>Elevation: '+a.elev+"+ feet</li><li>Temp Mean: "+a.temp_mean+" degrees</li><li>Water Mean: "+a.snow_mean+" inches</li><li>Water Median: "+a.snow_median+" inches</li></ul>").style("top",d3.event.pageY+18+"px").style("left",d3.event.pageX-55+"px");d3.select(this).attr("r",1.3*w(a.snow_mean))}).on("mouseout touchend",
        function(a){p.transition().duration(250).style("opacity",0);d3.select(this).attr("r",w(a.snow_mean))});b.exit().remove();500<=n&&("AZ"===a&&(b=[{xVal:m("2009"),yVal:6E3,path:"M104,43L83,29",text:"Max Temp Levels",textOffset:[57,54]}],q("#AZ",b,g,c)),"CA"===a&&(b=[{xVal:m("2015"),yVal:5E3,path:"M97,43L77,27",text:"Min Water Levels",textOffset:[57,54]}],q("#CA",b,g,c)),"CO"===a&&(b=[{xVal:m("2002"),yVal:9E3,path:"M46,-23L69,19",text:"Min Temp Levels",textOffset:[16,-25]}],q("#CO",b,g,c)),"WA"===a&&
        (b=[{xVal:m("2012"),yVal:6E3,path:"M110,-5L91,13",text:"Max Water Levels",textOffset:[87,-11]}],q("#WA",b,g,c)))});k=x(".row");k.classed("opaque",!1);k.classed("hide",!1);x("#load").classed("hide",!0)});